<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="shortcut icon" href="/images/favicon.png" />
    <style>
    html,body,li,p{margin:0;padding:0}p,ul,ol,.highlight{margin:1.6em 0}h1,h2,h3,h4{margin:0;padding:0;font-size:100%;font-weight:bold;text-rendering:optimizeLegibility;font-family:sans-serif}ul{list-style:none}html{box-sizing:border-box;font-size:62.5%}*{box-sizing:inherit}*:before,*:after{box-sizing:inherit}img{height:auto;max-width:100%}pre,code{font-family:monospace;margin:0}hr{display:block;height:1px;border:0;border-top:1px solid #efefef;margin:1rem 0;padding:0}blockquote{font-style:italic;margin:1.6em 0 1.6em -2.2em;padding:0 0 0 1.6em;border-left:#4a4a4a 0.4em solid}html{font-size:16px}@media screen and (min-width: 900px){html{font-size:18px}}@media screen and (min-width: 1200px){html{font-size:20px}}body{font-family:serif;color:#3A4145}h1{font-size:2rem;margin:10px 0 10px 0;letter-spacing:-1px}h2{font-size:1.4rem;letter-spacing:-1px}h3{font-size:1.2rem}h4{font-size:1.1rem}a:link,a:visited{color:inherit;text-decoration:none}a:hover{color:#57A3E8;transition:color ease 0.3s}p a:link,p a:visited{text-decoration:underline}pre{border:1px solid #E3EDF3;padding:10px;font-size:0.85em;border-radius:3px}code{padding:1px 3px;font-size:0.85em;white-space:pre;border:1px solid #E3EDF3;background:#F7FAFB;border-radius:2px}pre code{background:transparent;padding:0;border:0}.m-h{text-align:center;background-color:#303538;color:#fff;padding:1rem}.m-h h2{font-weight:normal;font-size:1.5rem}article{width:80%;margin:1rem auto;padding-bottom:1rem;border-bottom:#EBF2F6 1px solid;word-break:break-word;position:relative}article::after{display:block;content:"";width:7px;height:7px;border:#E7EEF2 1px solid;position:absolute;bottom:-5px;left:50%;margin-left:-5px;background:#fff;border-radius:100%;box-shadow:#fff 0 0 0 5px}.a-m{color:#9EABB3;font-size:0.8rem}.a-m a:hover{color:#9EABB3;text-decoration:underline}.a-h{margin-bottom:5px}.r-m{font-size:smaller}nav{position:relative;width:75%;margin:1rem auto;font-size:0.8rem;color:#9EABB3;text-align:center}.m-f{position:relative;margin:2rem 0 0 0;padding:1rem 1rem 2rem 1rem;border-top:#EBF2F6 1px solid;font-size:0.8rem;line-height:1.7em;color:#BBC7CC;text-align:center;background:#F7FAFB}.o-p,.n-p{position:absolute;display:inline-block;padding:0 0.5rem;border:#EBF2F6 2px solid;text-decoration:none;border-radius:30px;transition:border ease 0.3s}.o-p{right:0}.n-p{left:0}.t-h{width:80%;margin:0 auto}.highlight pre{background-color:#49483e;color:white;overflow:scroll}.ge{font-style:italic}.gs{font-weight:bold}.c,.cm,.cp,.c1,.gu,.cs{color:#75715e}.k,.kc,.kd,.kp,.kr,.no,.kt{color:#66d9ef}.l,.mf,.mh,.mi,.mo,.se,.il,.m{color:#ae81ff}.n,.nb,.ni,.nl,.nn,.py,.nv,.w,.bp,.vc,.vg,.vi,.p{color:#f8f8f2}.o,.nt,.ow,.gd,.kn{color:#f92672}.ld,.sb,.sc,.sd,.s2,.sh,.si,.sx,.sr,.s1,.ss,.s{color:#e6db74}.na,.nc,.nd,.ne,.nf,.nx,.gi{color:#a6e22e}

    </style>

    <!-- Begin Jekyll SEO tag v2.0.0 -->
<title>LINQ to SQL: Generic Primary Key function - Chris Sainty</title>
<meta property="og:title" content="LINQ to SQL: Generic Primary Key function" />
<meta name="description" content="An issue I have seen blogged about a number of times with LINQ-to-SQL is that by strong typing queries, you lose the ability to create generic functions for processes such as fetching records by their Primary Key." />
<meta property="og:description" content="An issue I have seen blogged about a number of times with LINQ-to-SQL is that by strong typing queries, you lose the ability to create generic functions for processes such as fetching records by their Primary Key." />
<link rel="canonical" href="https://blog.csainty.com/2008/04/linq-to-sql-generic-primary-key.html" />
<meta property="og:url" content="https://blog.csainty.com/2008/04/linq-to-sql-generic-primary-key.html" />
<meta property="og:site_name" content="Chris Sainty" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2008-04-15T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@csainty" />
<meta name="twitter:creator" content="@Chris Sainty" />
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "LINQ to SQL: Generic Primary Key function",
    "datePublished": "2008-04-15T00:00:00+00:00",
    "description": "An issue I have seen blogged about a number of times with LINQ-to-SQL is that by strong typing queries, you lose the ability to create generic functions for processes such as fetching records by their Primary Key.",
    "url": "https://blog.csainty.com/2008/04/linq-to-sql-generic-primary-key.html"
  }
</script>
<!-- End Jekyll SEO tag -->
</head>
<body>
  <header class="m-h">
    <h1><a href="https://blog.csainty.com">Chris Sainty</a></h1>
    <h2>A technical blog covering full-stack web development.</h2>
    <h2><a href="https://twitter.com/csainty" rel="external">twitter</a> | <a href="https://github.com/csainty" rel="external">github</a> | <a href="https://stackoverflow.com/users/625695/chris-sainty" rel="external">stackoverflow</a></h2>
  </header>

  <article>
    <span><time datetime="15 Apr 2008">15 Apr 2008</time>  </span>
    <h1>LINQ to SQL&#58; Generic Primary Key function</h1>
    <section>
        <p>An issue I have seen blogged about a number of times with LINQ-to-SQL is that by strong typing queries, you lose the ability to create generic functions for processes such as fetching records by their Primary Key.</p>

<!-- more -->

<p>A recent example is <a href="http://west-wind.com/weblog/posts/314663.aspx">Rick Strahl</a> who offers a number of good options for getting around this, while not being particularly happy with any of them. In the comments of Rick&#39;s post Richard Deeming offers a solution very similar to my own, which is to use the Meta-data provided by LINQ-to-SQL and the functionality of <code>System.Linq.Expressions</code> to create a simple and robust solution.</p>

<p>Here is an <a href="/2008/01/extension-methods.html">extension method</a> you can pop onto your <code>DataContext</code> object to facilitate the pulling of records from the database by their Primary Key.</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">DataContextHelpers</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">T</span> <span class="n">GetByPk</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">DataContext</span> <span class="n">context</span><span class="p">,</span> <span class="kt">object</span> <span class="n">pk</span><span class="p">)</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="k">class</span> <span class="err">{</span>
        <span class="nc">var</span> <span class="n">table</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">GetTable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;();</span>
        <span class="kt">var</span> <span class="n">mapping</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Mapping</span><span class="p">.</span><span class="nf">GetTable</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">T</span><span class="p">));</span>
        <span class="kt">var</span> <span class="n">pkfield</span> <span class="p">=</span> <span class="n">mapping</span><span class="p">.</span><span class="n">RowType</span><span class="p">.</span><span class="n">DataMembers</span><span class="p">.</span><span class="nf">SingleOrDefault</span><span class="p">(</span><span class="n">d</span> <span class="p">=&gt;</span> <span class="n">d</span><span class="p">.</span><span class="n">IsPrimaryKey</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pkfield</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">"Table {0} does not contain a Primary Key field"</span><span class="p">,</span> <span class="n">mapping</span><span class="p">.</span><span class="n">TableName</span><span class="p">));</span>
        <span class="kt">var</span> <span class="n">param</span> <span class="p">=</span> <span class="n">Expression</span><span class="p">.</span><span class="nf">Parameter</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">T</span><span class="p">),</span> <span class="s">"e"</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">predicate</span> <span class="p">=</span> <span class="n">Expression</span><span class="p">.</span><span class="n">Lambda</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;&gt;(</span><span class="n">Expression</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="n">Expression</span><span class="p">.</span><span class="nf">Property</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">pkfield</span><span class="p">.</span><span class="n">Name</span><span class="p">),</span> <span class="n">Expression</span><span class="p">.</span><span class="nf">Constant</span><span class="p">(</span><span class="n">pk</span><span class="p">)),</span> <span class="n">param</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">table</span><span class="p">.</span><span class="nf">SingleOrDefault</span><span class="p">(</span><span class="n">predicate</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>You can then run this code by doing the following</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">MyDataContext</span> <span class="n">db</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MyDataContext</span><span class="p">();</span>
<span class="n">Product</span> <span class="n">p</span> <span class="p">=</span> <span class="n">db</span><span class="p">.</span><span class="n">GetByPk</span><span class="p">&lt;</span><span class="n">Product</span><span class="p">&gt;(</span><span class="m">1</span><span class="p">);</span>
</code></pre></div>
<p><strong>Note:</strong> Excuse the excessive use of <code>var</code>. However it can be useful in the context of a code-snippet as it removes the need for you to work out all the using statements needed to make the code work.</p>

<p>So what does this code do, first we get a reference to the LINQ-to-SQL meta data store for the table we are querying, then pull out the Primary Key field for the table. It then builds a lambda expression tree that compares the Primary Key field of the parameter (that will be passed to the expression later) against the constant id passed to the function. This expression is then passed into LINQ-to-SQL where it can be decomposed and turned into SQL code. This is effectively the same as writing the lambda  <code>e =&gt; e.PK == id</code>, except that we work out the name for PK at run-time.</p>

<p>I have attached this as an extension method on the <code>DataContext</code>, but if you are using a base class for your entities, or writing a generic business object, you should be able to manipulate this fairly easily to do as you wish.</p>

<p>I have only scratched the surface of what may be possible with this technique of building code through Expression Tress, there is bound to be some interesting work done in this area as people get more and more accustomed to the concept.</p>

    </section>
</article>


  <footer class="m-f">
      <section class="copyright">All content copyright <a href="/">Chris Sainty</a> &copy; 2006-2017 &bull; All rights reserved.</section>
  </footer>
</body>
</html>
