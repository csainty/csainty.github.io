<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="shortcut icon" href="/images/favicon.png" />
    <style>
    html,body,li,p{margin:0;padding:0}p,ul,ol,.highlight{margin:1.6em 0}h1,h2,h3,h4{margin:0;padding:0;font-size:100%;font-weight:bold;text-rendering:optimizeLegibility;font-family:sans-serif}ul{list-style:none}html{box-sizing:border-box;font-size:62.5%}*{box-sizing:inherit}*:before,*:after{box-sizing:inherit}img{height:auto;max-width:100%}pre,code{font-family:monospace;margin:0}hr{display:block;height:1px;border:0;border-top:1px solid #efefef;margin:1rem 0;padding:0}blockquote{font-style:italic;margin:1.6em 0 1.6em -2.2em;padding:0 0 0 1.6em;border-left:#4a4a4a 0.4em solid}html{font-size:16px}@media screen and (min-width: 900px){html{font-size:18px}}@media screen and (min-width: 1200px){html{font-size:20px}}body{font-family:serif;color:#3A4145}h1{font-size:2rem;margin:10px 0 10px 0;letter-spacing:-1px}h2{font-size:1.4rem;letter-spacing:-1px}h3{font-size:1.2rem}h4{font-size:1.1rem}a:link,a:visited{color:inherit;text-decoration:none}a:hover{color:#57A3E8;transition:color ease 0.3s}p a:link,p a:visited{text-decoration:underline}pre{border:1px solid #E3EDF3;padding:10px;font-size:0.85em;border-radius:3px}code{padding:1px 3px;font-size:0.85em;white-space:pre;border:1px solid #E3EDF3;background:#F7FAFB;border-radius:2px}pre code{background:transparent;padding:0;border:0}.m-h{text-align:center;background-color:#303538;color:#fff;padding:1rem}.m-h h2{font-weight:normal;font-size:1.5rem}article{width:80%;margin:1rem auto;padding-bottom:1rem;border-bottom:#EBF2F6 1px solid;word-break:break-word;position:relative}article::after{display:block;content:"";width:7px;height:7px;border:#E7EEF2 1px solid;position:absolute;bottom:-5px;left:50%;margin-left:-5px;background:#fff;border-radius:100%;box-shadow:#fff 0 0 0 5px}.a-m{color:#9EABB3;font-size:0.8rem}.a-m a:hover{color:#9EABB3;text-decoration:underline}.a-h{margin-bottom:5px}.r-m{font-size:smaller}nav{position:relative;width:75%;margin:1rem auto;font-size:0.8rem;color:#9EABB3;text-align:center}.m-f{position:relative;margin:2rem 0 0 0;padding:1rem 1rem 2rem 1rem;border-top:#EBF2F6 1px solid;font-size:0.8rem;line-height:1.7em;color:#BBC7CC;text-align:center;background:#F7FAFB}.o-p,.n-p{position:absolute;display:inline-block;padding:0 0.5rem;border:#EBF2F6 2px solid;text-decoration:none;border-radius:30px;transition:border ease 0.3s}.o-p{right:0}.n-p{left:0}.t-h{width:80%;margin:0 auto}.highlight pre{background-color:#49483e;color:white;overflow:scroll}.ge{font-style:italic}.gs{font-weight:bold}.c,.cm,.cp,.c1,.gu,.cs{color:#75715e}.k,.kc,.kd,.kp,.kr,.no,.kt{color:#66d9ef}.l,.mf,.mh,.mi,.mo,.se,.il,.m{color:#ae81ff}.n,.nb,.ni,.nl,.nn,.py,.nv,.w,.bp,.vc,.vg,.vi,.p{color:#f8f8f2}.o,.nt,.ow,.gd,.kn{color:#f92672}.ld,.sb,.sc,.sd,.s2,.sh,.si,.sx,.sr,.s1,.ss,.s{color:#e6db74}.na,.nc,.nd,.ne,.nf,.nx,.gi{color:#a6e22e}

    </style>

    <!-- Begin Jekyll SEO tag v2.0.0 -->
<title>ASP.NET MVC - Testing - Chris Sainty</title>
<meta property="og:title" content="ASP.NET MVC - Testing" />
<meta name="description" content="I have been further exploring the concepts of Test Driven Development of late, in particular around the ASP.NET MVC framework.  One concept that is very new to me is mocking. I have been using Rhino Mocks. This is not going to be a post about mocking, I am far much of a novice to offer any useful advice on this front just yet. However, it is pretty cool stuff and worth a read.  " />
<meta property="og:description" content="I have been further exploring the concepts of Test Driven Development of late, in particular around the ASP.NET MVC framework.  One concept that is very new to me is mocking. I have been using Rhino Mocks. This is not going to be a post about mocking, I am far much of a novice to offer any useful advice on this front just yet. However, it is pretty cool stuff and worth a read.  " />
<link rel="canonical" href="https://blog.csainty.com/2008/03/aspnet-mvc-testing.html" />
<meta property="og:url" content="https://blog.csainty.com/2008/03/aspnet-mvc-testing.html" />
<meta property="og:site_name" content="Chris Sainty" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2008-03-12T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@csainty" />
<meta name="twitter:creator" content="@Chris Sainty" />
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "ASP.NET MVC - Testing",
    "datePublished": "2008-03-12T00:00:00+00:00",
    "description": "I have been further exploring the concepts of Test Driven Development of late, in particular around the ASP.NET MVC framework.  One concept that is very new to me is mocking. I have been using Rhino Mocks. This is not going to be a post about mocking, I am far much of a novice to offer any useful advice on this front just yet. However, it is pretty cool stuff and worth a read.  ",
    "url": "https://blog.csainty.com/2008/03/aspnet-mvc-testing.html"
  }
</script>
<!-- End Jekyll SEO tag -->
</head>
<body>
  <header class="m-h">
    <h1><a href="https://blog.csainty.com">Chris Sainty</a></h1>
    <h2>A technical blog covering full-stack web development.</h2>
    <h2><a href="https://twitter.com/csainty" rel="external">twitter</a> | <a href="https://github.com/csainty" rel="external">github</a> | <a href="https://stackoverflow.com/users/625695/chris-sainty" rel="external">stackoverflow</a></h2>
  </header>

  <article>
    <span><time datetime="12 Mar 2008">12 Mar 2008</time>  </span>
    <h1>ASP.NET MVC - Testing</h1>
    <section>
        <p>I have been further exploring the concepts of Test Driven Development of late, in particular around the ASP.NET MVC framework.  </p>

<p>One concept that is very new to me is mocking. I have been using <a href="http://ayende.com/projects/rhino-mocks.aspx">Rhino Mocks</a>. This is not going to be a post about mocking, I am far much of a novice to offer any useful advice on this front just yet. However, it is pretty cool stuff and worth a read.  </p>

<!-- more -->

<p>The MVC team have been talking a lot about testing and mocking lately, and I have found that trying to get a clear picture of exactly where they are at is quite difficult. Most examples and blogs pre-date the latest code refresh and either do or do-not work because of this. One useful resource so far though is this <a href="http://www.hanselman.com/blog/ASPNETMVCSessionAtMix08TDDAndMvcMockHelpers.aspx">post</a> from <a href="http://feeds.feedburner.com/ScottHanselman">Scott Hanselman</a>.  </p>

<p>He provides a nice simple set of Mocks for the basic <code>HTTPContext</code> objects, which at this stage are very useful if you want to unit test your controllers.  </p>

<p>It is not a complete solution though. The real sticking point is the <code>RedirectToAction()</code> method. It is difficult to mock. Over on <a href="http://www.codeplex.com/MVCContrib/Wiki/View.aspx?title=TestHelper&amp;referringTitle=Documentation">MvcContrib</a> however they have an implementation that uses interception classes from the Castle project to intercept calls to <code>RedirectToAction()</code> to supply their own functionality. A clever if cumbersome approach.  </p>

<p>The following code snippets have a few dependencies. The Rhino Mocks dlls can be found at the URL I mentioned above, and the Castle.Core and Castle.DynamicProxy2 dlls can be found amongst the MvcContrib release.  </p>

<p>Now on to some code. I have a method in my controller unit test base class to create a controller for me, configure up the mocked HTTPContext objects from scott, add a fake ViewEngine and intercept the RedirectToAction() method. Works well so far, and looks a bit like this.</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="n">T</span> <span class="n">CreateController</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;()</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="n">Controller</span><span class="p">,</span> <span class="k">new</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">ProxyGenerator</span> <span class="n">generator</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ProxyGenerator</span><span class="p">();</span>
    <span class="n">T</span> <span class="n">c</span> <span class="p">=</span> <span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="n">generator</span><span class="p">.</span><span class="nf">CreateClassProxy</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">T</span><span class="p">),</span> <span class="k">new</span> <span class="nf">ControllerInterceptor</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
    <span class="n">c</span><span class="p">.</span><span class="n">ViewEngine</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MockViewEngine</span><span class="p">();</span>
    <span class="n">Mocks</span><span class="p">.</span><span class="nf">SetFakeControllerContext</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p><code>ProxyGenerator</code> comes from Castle.<br>
<code>Mocks</code> is a <code>MockRepository</code> stored on the base class.<br>
<code>MockViewEngine</code> is an empty class that implements <code>IViewEngine</code> but does nothing yet, I want to implement something on this but I have not decided exactly what yet.  </p>

<p>The interceptor looks like this. I had to change the one from MvcContrib because it was not working on the new Preview 2 release of MVC. Also I still wanted it to let the ViewEngine get involved incase I wanted processing there, something the MvcContrib did not do.  </p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">ControllerInterceptor</span> <span class="p">:</span> <span class="n">IInterceptor</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">TestClassController</span> <span class="n">_parent</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">ControllerInterceptor</span><span class="p">(</span><span class="n">TestClassController</span> <span class="n">parent</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_parent</span> <span class="p">=</span> <span class="n">parent</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Intercept</span><span class="p">(</span><span class="n">IInvocation</span> <span class="n">invocation</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">invocation</span><span class="p">.</span><span class="n">Method</span><span class="p">.</span><span class="n">Name</span> <span class="p">==</span> <span class="s">"RenderView"</span> <span class="p">&amp;&amp;</span> <span class="n">invocation</span><span class="p">.</span><span class="n">Arguments</span><span class="p">.</span><span class="n">Length</span> <span class="p">==</span> <span class="m">3</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">string</span> <span class="n">viewName</span> <span class="p">=</span> <span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="n">invocation</span><span class="p">.</span><span class="n">Arguments</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
            <span class="kt">string</span> <span class="n">masterName</span> <span class="p">=</span> <span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="n">invocation</span><span class="p">.</span><span class="n">Arguments</span><span class="p">[</span><span class="m">1</span><span class="p">];</span>
            <span class="kt">object</span> <span class="n">viewData</span> <span class="p">=</span> <span class="p">(</span><span class="kt">object</span><span class="p">)</span><span class="n">invocation</span><span class="p">.</span><span class="n">Arguments</span><span class="p">[</span><span class="m">2</span><span class="p">];</span>
            <span class="n">_parent</span><span class="p">.</span><span class="n">RenderViewData</span> <span class="p">=</span> <span class="k">new</span> <span class="n">RenderViewData</span>
            <span class="p">{</span>
                <span class="n">ViewName</span> <span class="p">=</span> <span class="n">viewName</span><span class="p">,</span>
                <span class="n">MasterName</span> <span class="p">=</span> <span class="n">masterName</span><span class="p">,</span>
                <span class="n">ViewData</span> <span class="p">=</span> <span class="n">viewData</span>
            <span class="p">};</span>
            <span class="c1">//return;
</span>        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">invocation</span><span class="p">.</span><span class="n">Method</span><span class="p">.</span><span class="n">Name</span> <span class="p">==</span> <span class="s">"RedirectToAction"</span> <span class="p">&amp;&amp;</span> <span class="n">invocation</span><span class="p">.</span><span class="n">Arguments</span><span class="p">.</span><span class="n">Length</span> <span class="p">==</span> <span class="m">1</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">RouteValueDictionary</span> <span class="k">value</span> <span class="p">=</span> <span class="n">invocation</span><span class="p">.</span><span class="n">Arguments</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="k">as</span> <span class="n">RouteValueDictionary</span><span class="p">;</span>
            <span class="kt">string</span> <span class="n">actionName</span> <span class="p">=</span> <span class="k">value</span><span class="p">.</span><span class="nf">ContainsKey</span><span class="p">(</span><span class="s">"Action"</span><span class="p">)</span> <span class="p">?</span> <span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="k">value</span><span class="p">[</span><span class="s">"Action"</span><span class="p">]</span> <span class="p">:</span> <span class="s">""</span><span class="p">;</span>
            <span class="kt">string</span> <span class="n">controllerName</span> <span class="p">=</span> <span class="k">value</span><span class="p">.</span><span class="nf">ContainsKey</span><span class="p">(</span><span class="s">"Controller"</span><span class="p">)</span> <span class="p">?</span> <span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="k">value</span><span class="p">[</span><span class="s">"Controller"</span><span class="p">]</span> <span class="p">:</span> <span class="s">""</span><span class="p">;</span>
            <span class="n">_parent</span><span class="p">.</span><span class="n">RedirectToActionData</span> <span class="p">=</span> <span class="k">new</span> <span class="n">RedirectToActionData</span>
            <span class="p">{</span>
                <span class="n">ActionName</span> <span class="p">=</span> <span class="n">actionName</span><span class="p">,</span>
                <span class="n">ControllerName</span> <span class="p">=</span> <span class="n">controllerName</span>
            <span class="p">};</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">invocation</span><span class="p">.</span><span class="nf">Proceed</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>With all this set up and hooked together (I have left a few bits out, you will need to create the <code>RenderViewData</code> and <code>RedirectToActionData</code> classes, just holders for the properties used) you can reduce your actual unit testing code down pretty small.  </p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="na">[TestMethod()]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">IndexTest</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">controller</span> <span class="p">=</span> <span class="n">CreateController</span><span class="p">&lt;</span><span class="n">HomeController</span><span class="p">&gt;();</span>
    <span class="n">controller</span><span class="p">.</span><span class="nf">Index</span><span class="p">();</span>
    <span class="n">Assert</span><span class="p">.</span><span class="nf">AreEqual</span><span class="p">(</span><span class="s">"Index"</span><span class="p">,</span> <span class="n">RenderViewData</span><span class="p">.</span><span class="n">ViewName</span><span class="p">);</span>
<span class="p">}</span>


<span class="na">[TestMethod()]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">ListNotFoundTest</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">controller</span> <span class="p">=</span> <span class="n">CreateController</span><span class="p">&lt;</span><span class="n">ProductController</span><span class="p">&gt;();</span>
    <span class="n">controller</span><span class="p">.</span><span class="nf">List</span><span class="p">(</span><span class="s">"1000"</span><span class="p">,</span> <span class="m">1</span><span class="p">);</span>
    <span class="n">Assert</span><span class="p">.</span><span class="nf">AreEqual</span><span class="p">(</span><span class="s">"ProductNotFound"</span><span class="p">,</span> <span class="n">RedirectToActionData</span><span class="p">.</span><span class="n">ActionName</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>Its a shame that such simple tests currently require such elaborate mechanisms. The MVC guys assure us that they are listening and will be bundling in helpers or changing the framework to make these things simpler in the coming releases, for the time being though it is a bit of fun if you give it a chance.  </p>

<p>One thing I would like to do is integrate Route testing with Controller testing. So instead of calling <code>Controller.List(&quot;1000&quot;, 1);</code> I could <code>CallURL(&quot;/Product/List/1000/1&quot;);</code> and have the routing classes fire up and map the URL through.</p>

<p>I would also later like a simple way to compile the .aspx view. I dont really need to run it as I don&#39;t want to check its output at this stage. But simply checking it compiled would be a good start. This is why I have a placeholder <code>ViewEngine</code> at the moment instead of just mocking <code>RenderView()</code> to do nothing.  </p>

<p>Overall I am very happy with the framework, I am waiting to get my hands on a dedicated test server in the near future to set up  Continuous Integration and some load/performance tests. That should be fun.  </p>

    </section>
</article>


  <footer class="m-f">
      <section class="copyright">All content copyright <a href="/">Chris Sainty</a> &copy; 2006-2017 &bull; All rights reserved.</section>
  </footer>
</body>
</html>
