<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="shortcut icon" href="/images/favicon.png" />
    <style>
    html,body,li,p{margin:0;padding:0}p,ul,ol,.highlight{margin:1.6em 0}h1,h2,h3,h4{margin:0;padding:0;font-size:100%;font-weight:bold;text-rendering:optimizeLegibility;font-family:sans-serif}ul{list-style:none}html{box-sizing:border-box;font-size:62.5%}*{box-sizing:inherit}*:before,*:after{box-sizing:inherit}img{height:auto;max-width:100%}pre,code{font-family:monospace;margin:0}hr{display:block;height:1px;border:0;border-top:1px solid #efefef;margin:1rem 0;padding:0}blockquote{font-style:italic;margin:1.6em 0 1.6em -2.2em;padding:0 0 0 1.6em;border-left:#4a4a4a 0.4em solid}html{font-size:16px}@media screen and (min-width: 900px){html{font-size:18px}}@media screen and (min-width: 1200px){html{font-size:20px}}body{font-family:serif;color:#3A4145}h1{font-size:2rem;margin:10px 0 10px 0;letter-spacing:-1px}h2{font-size:1.4rem;letter-spacing:-1px}h3{font-size:1.2rem}h4{font-size:1.1rem}a:link,a:visited{color:inherit;text-decoration:none}a:hover{color:#57A3E8;transition:color ease 0.3s}p a:link,p a:visited{text-decoration:underline}pre{border:1px solid #E3EDF3;padding:10px;font-size:0.85em;border-radius:3px}code{padding:1px 3px;font-size:0.85em;white-space:pre;border:1px solid #E3EDF3;background:#F7FAFB;border-radius:2px}pre code{background:transparent;padding:0;border:0}.m-h{text-align:center;background-color:#303538;color:#fff;padding:1rem}.m-h h2{font-weight:normal;font-size:1.5rem}article{width:80%;margin:1rem auto;padding-bottom:1rem;border-bottom:#EBF2F6 1px solid;word-break:break-word;position:relative}article::after{display:block;content:"";width:7px;height:7px;border:#E7EEF2 1px solid;position:absolute;bottom:-5px;left:50%;margin-left:-5px;background:#fff;border-radius:100%;box-shadow:#fff 0 0 0 5px}.a-m{color:#9EABB3;font-size:0.8rem}.a-m a:hover{color:#9EABB3;text-decoration:underline}.a-h{margin-bottom:5px}.r-m{font-size:smaller}nav{position:relative;width:75%;margin:1rem auto;font-size:0.8rem;color:#9EABB3;text-align:center}.m-f{position:relative;margin:2rem 0 0 0;padding:1rem 1rem 2rem 1rem;border-top:#EBF2F6 1px solid;font-size:0.8rem;line-height:1.7em;color:#BBC7CC;text-align:center;background:#F7FAFB}.o-p,.n-p{position:absolute;display:inline-block;padding:0 0.5rem;border:#EBF2F6 2px solid;text-decoration:none;border-radius:30px;transition:border ease 0.3s}.o-p{right:0}.n-p{left:0}.t-h{width:80%;margin:0 auto}.highlight pre{background-color:#49483e;color:white;overflow:scroll}.ge{font-style:italic}.gs{font-weight:bold}.c,.cm,.cp,.c1,.gu,.cs{color:#75715e}.k,.kc,.kd,.kp,.kr,.no,.kt{color:#66d9ef}.l,.mf,.mh,.mi,.mo,.se,.il,.m{color:#ae81ff}.n,.nb,.ni,.nl,.nn,.py,.nv,.w,.bp,.vc,.vg,.vi,.p{color:#f8f8f2}.o,.nt,.ow,.gd,.kn{color:#f92672}.ld,.sb,.sc,.sd,.s2,.sh,.si,.sx,.sr,.s1,.ss,.s{color:#e6db74}.na,.nc,.nd,.ne,.nf,.nx,.gi{color:#a6e22e}

    </style>

    <!-- Begin Jekyll SEO tag v2.0.0 -->
<title>Wp7.5 Mango–Background Agents - Chris Sainty</title>
<meta property="og:title" content="Wp7.5 Mango–Background Agents" />
<meta name="description" content="Late last year when I implemented the unread count Live Tile in gReadie I found myself stunned at just how complicated it was. It seemed to me that it would make a lot more sense if I could just whack a [LiveTileUpdater] attribute on a static method in a class and the phone would run that method occasionally.  I was therefore delighted when details about Mango were released as this is basically what Microsoft implemented.  " />
<meta property="og:description" content="Late last year when I implemented the unread count Live Tile in gReadie I found myself stunned at just how complicated it was. It seemed to me that it would make a lot more sense if I could just whack a [LiveTileUpdater] attribute on a static method in a class and the phone would run that method occasionally.  I was therefore delighted when details about Mango were released as this is basically what Microsoft implemented.  " />
<link rel="canonical" href="https://blog.csainty.com/2011/08/wp75-mangobackground-agents.html" />
<meta property="og:url" content="https://blog.csainty.com/2011/08/wp75-mangobackground-agents.html" />
<meta property="og:site_name" content="Chris Sainty" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2011-08-19T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@csainty" />
<meta name="twitter:creator" content="@Chris Sainty" />
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "Wp7.5 Mango–Background Agents",
    "datePublished": "2011-08-19T00:00:00+00:00",
    "description": "Late last year when I implemented the unread count Live Tile in gReadie I found myself stunned at just how complicated it was. It seemed to me that it would make a lot more sense if I could just whack a [LiveTileUpdater] attribute on a static method in a class and the phone would run that method occasionally.  I was therefore delighted when details about Mango were released as this is basically what Microsoft implemented.  ",
    "url": "https://blog.csainty.com/2011/08/wp75-mangobackground-agents.html"
  }
</script>
<!-- End Jekyll SEO tag -->
</head>
<body>
  <header class="m-h">
    <h1><a href="https://blog.csainty.com">Chris Sainty</a></h1>
    <h2>A technical blog covering full-stack web development.</h2>
    <h2><a href="https://twitter.com/csainty" rel="external">twitter</a> | <a href="https://github.com/csainty" rel="external">github</a> | <a href="https://stackoverflow.com/users/625695/chris-sainty" rel="external">stackoverflow</a></h2>
  </header>

  <article>
    <span><time datetime="19 Aug 2011">19 Aug 2011</time>  </span>
    <h1>Wp7.5 Mango–Background Agents</h1>
    <section>
        <p>Late last year when I implemented the unread count Live Tile in <a href="http://www.quidsmobile.com/greadie/">gReadie</a> I found myself stunned at just how complicated it was. It seemed to me that it would make a lot more sense if I could just whack a <code>[LiveTileUpdater]</code> attribute on a static method in a class and the phone would run that method occasionally.  </p>

<p>I was therefore delighted when details about Mango were released as this is basically what Microsoft implemented.  </p>

<!-- more --> 

<p>Background Agents in Mango take the form of a separate assembly, which gets linked in your <code>WMAppManifest.xml</code>  </p>
<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;Tasks&gt;</span>
    <span class="nt">&lt;DefaultTask</span> <span class="na">Name=</span><span class="s">"_default"</span> <span class="na">NavigationPage=</span><span class="s">"Home.xaml"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;ExtendedTask</span> <span class="na">Name=</span><span class="s">"BackgroundTask"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;BackgroundServiceAgent</span> <span class="na">Specifier=</span><span class="s">"ScheduledTaskAgent"</span> <span class="na">Name=</span><span class="s">"gReadie.BackgroundAgent"</span> <span class="na">Source=</span><span class="s">"gReadie.BackgroundAgent"</span> <span class="na">Type=</span><span class="s">"gReadie.BackgroundAgent.ScheduledAgent"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/ExtendedTask&gt;</span>
<span class="nt">&lt;/Tasks&gt;</span>
</code></pre></div>
<p>You should also place a reference to this library in your main app just to make sure the compiler includes it in your <code>.xap</code> file.  </p>

<p>You Background Agent library should contain a class based on <code>ScheduledTaskAgent</code> which performs the actual tasks.</p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">ScheduledAgent</span> <span class="p">:</span> <span class="n">ScheduledTaskAgent</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnInvoke</span><span class="p">(</span><span class="n">ScheduledTask</span> <span class="n">task</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">task</span> <span class="k">is</span> <span class="n">PeriodicTask</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Do quick processing
</span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// Do long processing
</span>        <span class="p">}</span>
        <span class="nf">NotifyComplete</span><span class="p">();</span>  <span class="c1">// or Abort();
</span>    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>There are two types of Background Agents, <a href="http://msdn.microsoft.com/en-us/library/microsoft.phone.scheduler.periodictask.aspx">PeriodicTask</a> and <a href="http://msdn.microsoft.com/en-us/library/microsoft.phone.scheduler.resourceintensivetask.aspx">ResourceIntensiveTask</a>. Your app is allowed one of each.  </p>

<p>Full details are available <a href="http://msdn.microsoft.com/en-us/library/hh202942.aspx">here</a>, but the important parts are that <code>PeriodicTasks</code> run around every 30minutes and can only run for 15 seconds before being killed. <code>ResourceIntensiveTasks</code> run when the phone is plugged in, on wi-fi and charged to over 90% battery, they can run for 10 minutes.  </p>

<p>Finally your task should call either <code>NotifyComplete()</code> or <code>Abort()</code> when it is finished. <code>Abort()</code> will unschedule the task until your app runs again, so you only call it if something is wrong that needs user attention, such as login credentials changing.  </p>

<p>Now that is the good part of the story, there is one more restriction on Background Agents. They are only allowed 5MB of memory, regardless of whether they are <code>Periodic</code> or <code>ResourceIntensive</code>. If you go over this limit the task will be killed.  </p>

<p>Making a useful Background Agent that stays under these limits is incredibly difficult. Especially when so many of the basic framework components (HttPWebRequest, LINQ-to-SQL, IsolatedStorageSettings) appear to have memory leaks.  </p>

<p>From my testing you will lose about half your memory by the time you reach line 1. Your first <code>HttpWebRequest</code> will eat up another roughly 20%, which it never gives back, though multiple requests will stay inside that initial chunk. <code>IsolatedStorageSettings</code> will do a similar thing.  </p>

<p>LINQ-to-SQL is a little more complex, recycling your <code>DataContext</code> and <a href="/2011/08/wp75-mangocompiled-queries.html">Compiled Queries</a> will give some back, but recycling them too often will leak as well. So you need to find a nice balance.  </p>

<p>I suggest writing some code to monitor the memory usage between each job (assuming you have multiple to perform, say downloading multiple RSS feeds like gReadie does) and if you stray too high, then perform a garbage collection and recycle your LINQ-to-SQL and see how much you can get back. If it is not enough, then <code>NotifyComplete()</code> and try exit gracefully. It is not bullet-proof but in my testing it allows me to get more work done before running out of memory.  </p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">if</span> <span class="p">(((</span><span class="kt">double</span><span class="p">)</span><span class="n">DeviceStatus</span><span class="p">.</span><span class="n">ApplicationCurrentMemoryUsage</span> <span class="p">/</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">DeviceStatus</span><span class="p">.</span><span class="n">ApplicationMemoryUsageLimit</span><span class="p">)</span> <span class="p">*</span> <span class="m">100d</span> <span class="p">&gt;</span> <span class="m">97d</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// We are using too much memory, try clean a few things up
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">_Ctx</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
        <span class="n">_Ctx</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
    <span class="n">_Ctx</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">gReadieModelContext</span><span class="p">(</span><span class="n">gReadieModelContext</span><span class="p">.</span><span class="n">ConnectionString</span><span class="p">);</span>
    <span class="n">GC</span><span class="p">.</span><span class="nf">Collect</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(((</span><span class="kt">double</span><span class="p">)</span><span class="n">DeviceStatus</span><span class="p">.</span><span class="n">ApplicationCurrentMemoryUsage</span> <span class="p">/</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">DeviceStatus</span><span class="p">.</span><span class="n">ApplicationMemoryUsageLimit</span><span class="p">)</span> <span class="p">*</span> <span class="m">100d</span> <span class="p">&gt;</span> <span class="m">97d</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// We couldn't recover enough memory, so we are really running out, lets be nice and bail
</span>        <span class="nf">NotifyComplete</span><span class="p">();</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
    </section>
</article>


  <footer class="m-f">
      <section class="copyright">All content copyright <a href="/">Chris Sainty</a> &copy; 2006-2017 &bull; All rights reserved.</section>
  </footer>
</body>
</html>
