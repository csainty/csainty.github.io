<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="shortcut icon" href="/images/favicon.png" />
    <style>
    html,body,li,p{margin:0;padding:0}p,ul,ol,.highlight{margin:1.6em 0}h1,h2,h3,h4{margin:0;padding:0;font-size:100%;font-weight:bold;text-rendering:optimizeLegibility;font-family:sans-serif}ul{list-style:none}html{box-sizing:border-box;font-size:62.5%}*{box-sizing:inherit}*:before,*:after{box-sizing:inherit}img{height:auto;max-width:100%}pre,code{font-family:monospace;margin:0}hr{display:block;height:1px;border:0;border-top:1px solid #efefef;margin:1rem 0;padding:0}blockquote{font-style:italic;margin:1.6em 0 1.6em -2.2em;padding:0 0 0 1.6em;border-left:#4a4a4a 0.4em solid}html{font-size:16px}@media screen and (min-width: 900px){html{font-size:18px}}@media screen and (min-width: 1200px){html{font-size:20px}}body{font-family:serif;color:#3A4145}h1{font-size:2rem;margin:10px 0 10px 0;letter-spacing:-1px}h2{font-size:1.4rem;letter-spacing:-1px}h3{font-size:1.2rem}h4{font-size:1.1rem}a:link,a:visited{color:inherit;text-decoration:none}a:hover{color:#57A3E8;transition:color ease 0.3s}p a:link,p a:visited{text-decoration:underline}pre{border:1px solid #E3EDF3;padding:10px;font-size:0.85em;border-radius:3px}code{padding:1px 3px;font-size:0.85em;white-space:pre;border:1px solid #E3EDF3;background:#F7FAFB;border-radius:2px}pre code{background:transparent;padding:0;border:0}.m-h{text-align:center;background-color:#303538;color:#fff;padding:1rem}.m-h h2{font-weight:normal;font-size:1.5rem}article{width:80%;margin:1rem auto;padding-bottom:1rem;border-bottom:#EBF2F6 1px solid;word-break:break-word;position:relative}article::after{display:block;content:"";width:7px;height:7px;border:#E7EEF2 1px solid;position:absolute;bottom:-5px;left:50%;margin-left:-5px;background:#fff;border-radius:100%;box-shadow:#fff 0 0 0 5px}.a-m{color:#9EABB3;font-size:0.8rem}.a-m a:hover{color:#9EABB3;text-decoration:underline}.a-h{margin-bottom:5px}.r-m{font-size:smaller}nav{position:relative;width:75%;margin:1rem auto;font-size:0.8rem;color:#9EABB3;text-align:center}.m-f{position:relative;margin:2rem 0 0 0;padding:1rem 1rem 2rem 1rem;border-top:#EBF2F6 1px solid;font-size:0.8rem;line-height:1.7em;color:#BBC7CC;text-align:center;background:#F7FAFB}.o-p,.n-p{position:absolute;display:inline-block;padding:0 0.5rem;border:#EBF2F6 2px solid;text-decoration:none;border-radius:30px;transition:border ease 0.3s}.o-p{right:0}.n-p{left:0}.t-h{width:80%;margin:0 auto}.highlight pre{background-color:#49483e;color:white;overflow:scroll}.ge{font-style:italic}.gs{font-weight:bold}.c,.cm,.cp,.c1,.gu,.cs{color:#75715e}.k,.kc,.kd,.kp,.kr,.no,.kt{color:#66d9ef}.l,.mf,.mh,.mi,.mo,.se,.il,.m{color:#ae81ff}.n,.nb,.ni,.nl,.nn,.py,.nv,.w,.bp,.vc,.vg,.vi,.p{color:#f8f8f2}.o,.nt,.ow,.gd,.kn{color:#f92672}.ld,.sb,.sc,.sd,.s2,.sh,.si,.sx,.sr,.s1,.ss,.s{color:#e6db74}.na,.nc,.nd,.ne,.nf,.nx,.gi{color:#a6e22e}

    </style>

    <!-- Begin Jekyll SEO tag v2.0.0 -->
<title>Scripted Text Generation - Chris Sainty</title>
<meta property="og:title" content="Scripted Text Generation" />
<meta name="description" content="The first piece of code I would like to post is one of my favourites, in that geeky kind of way.A quick little routine to take a file that mixes static text with foxpro expressions and scripting then turns it into a foxpro procedure.We use this code to process HTML and XML template files used by our websites into efficient compiled foxpro code.I made mention of this code as part of my presentation at OzFox Lite in March 2006. So here it is!" />
<meta property="og:description" content="The first piece of code I would like to post is one of my favourites, in that geeky kind of way.A quick little routine to take a file that mixes static text with foxpro expressions and scripting then turns it into a foxpro procedure.We use this code to process HTML and XML template files used by our websites into efficient compiled foxpro code.I made mention of this code as part of my presentation at OzFox Lite in March 2006. So here it is!" />
<link rel="canonical" href="https://blog.csainty.com/2006/04/scripted-text-generation.html" />
<meta property="og:url" content="https://blog.csainty.com/2006/04/scripted-text-generation.html" />
<meta property="og:site_name" content="Chris Sainty" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2006-04-10T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@csainty" />
<meta name="twitter:creator" content="@Chris Sainty" />
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "Scripted Text Generation",
    "datePublished": "2006-04-10T00:00:00+00:00",
    "description": "The first piece of code I would like to post is one of my favourites, in that geeky kind of way.A quick little routine to take a file that mixes static text with foxpro expressions and scripting then turns it into a foxpro procedure.We use this code to process HTML and XML template files used by our websites into efficient compiled foxpro code.I made mention of this code as part of my presentation at OzFox Lite in March 2006. So here it is!",
    "url": "https://blog.csainty.com/2006/04/scripted-text-generation.html"
  }
</script>
<!-- End Jekyll SEO tag -->
</head>
<body>
  <header class="m-h">
    <h1><a href="https://blog.csainty.com">Chris Sainty</a></h1>
    <h2>A technical blog covering full-stack web development.</h2>
    <h2><a href="https://twitter.com/csainty" rel="external">twitter</a> | <a href="https://github.com/csainty" rel="external">github</a> | <a href="https://stackoverflow.com/users/625695/chris-sainty" rel="external">stackoverflow</a></h2>
  </header>

  <article>
    <span><time datetime="10 Apr 2006">10 Apr 2006</time>  </span>
    <h1>Scripted Text Generation</h1>
    <section>
        <p>The first piece of code I would like to post is one of my favourites, in that geeky kind of way.
A quick little routine to take a file that mixes static text with foxpro expressions and scripting then turns it into a foxpro procedure.</p>

<p>We use this code to process HTML and XML template files used by our websites into efficient compiled foxpro code.
I made mention of this code as part of my presentation at <a href="http://www.ozfox.com.au/">OzFox Lite</a> in March 2006. So here it is!</p>

<!-- more -->
<div class="highlight"><pre><code class="language-XBase" data-lang="XBase">### Code

#define k_NL      chr(13) + chr(10)
#define k_VARIABLE    "__cS"
#define k_BLOCK_OPEN  "&lt;%"    &amp;&amp; open code blocks
#define k_BLOCK_CLOSE  "%&gt;"    &amp;&amp; close code blocks
#define k_EXP_OPEN    "&lt;%="    &amp;&amp; open expressions
#define k_EXP_CLOSE    "%&gt;"    &amp;&amp; close expressions
#define k_QUOTE_OPEN  '['      &amp;&amp; open quote for strings
#define k_QUOTE_CLOSE  ']'      &amp;&amp; close quote for strings
#define k_QUOTE2_OPEN   [']      &amp;&amp; open quote mark safe to wrap other quote marks in
#define k_QUOTE2_CLOSE  [']      &amp;&amp; close quote mark safe to wrap other quote marks in
#define k_SPECIAL    k_QUOTE_OPEN + k_QUOTE_CLOSE + [&amp;]  &amp;&amp; Break these synbols out of the string and wrap in quote2
#define k_MAX_LINES    20
#define k_MAX_STRING  254
#define k_SAVE_INDENT  .T.

function compilePage
*************************
lparameters cStr, cFName 
local cS, cLine, inScript, inLine, nLines, cLinePre
local array a_file[1]
nLines= 0
cS= 'function ' + m.cFName + k_NL ;
  + 'lparameters ' + k_VARIABLE + k_NL ;
  + k_VARIABLE + "= " + k_QUOTE_OPEN + k_QUOTE_CLOSE + k_NL
cLinePre= ''
for i = 1 to alines(a_file, m.cStr)
  cLine= alltrim(chrtran(a_file[m.i], chr(9) + chr(10) + chr(13), ''))
  #if k_SAVE_INDENT
    cLinePre= left(a_file[m.i], at(left(m.cLine, 1), a_file[m.i]) - 1)
  #endif
  if !empty(m.cLine)
    do case
      case m.cLine = k_BLOCK_OPEN and m.cLine # k_EXP_OPEN
        inScript= at(k_BLOCK_CLOSE, m.cLine) = 0
        if m.inLine
          inLine= .F.
          cS= left(m.cS, rat(';', m.cS) - 1) + k_NL
          nLines= 0
        endif
        cLine= alltrim(strextract(m.cLine, k_BLOCK_OPEN, k_BLOCK_CLOSE, 1, 2))
        if !empty(m.cLine)
          cS= m.cS + compileLine(m.cLine) + k_NL
        endif
      case ltrim(m.cLine) = k_BLOCK_CLOSE
        inScript= .F.
        nLines= 0
      case m.inScript
        if at(k_BLOCK_CLOSE, m.cLine) # 0
          cLine= substr(m.cLine, 1, at(k_BLOCK_CLOSE, m.cLine) - 1)
          nLines= 0
          inScript= .f.
        endif
        if m.cLine # "*" and m.cLine # "&amp;" + "&amp;"
          cS= m.cS + compileLine(m.cLine) + k_NL
        endif
      otherwise
        if !m.inLine or m.nLines = k_MAX_LINES
          if m.nLines= k_MAX_LINES
            cS= left(m.cS, rat(';', m.cS) - 1) + k_NL
          endif
          nLines= 0
          cS= m.cS + k_VARIABLE + "= m." + k_VARIABLE + " "
          inLine= .T.
        else
          nLines= m.nLines + 1
          cS= m.cS + chr(9)
        endif
        cS= m.cS + "+ " + alltrim(compileExpr(m.cLine, m.cLinePre)) + " + chr(13)+chr(10)" + iif(m.inLine, ' ;', '') + k_NL
    endcase
  endif
endfor
if m.inLine
  inLine= .F.
  cS= left(m.cS, rat(';', m.cS) - 1) + k_NL
endif
return m.cS + k_NL + k_NL

function compileLine
*********************
lparameters cS
cS= alltrim(m.cS)
do case
case m.cS = "?"
  cS= k_VARIABLE + "= m." + k_VARIABLE + " + " + alltrim(substr(m.cS, 2)) + " + chr(13)+chr(10)"
  
otherwise
  * do nothing
endcase
return m.cS

function compileExpr
*********************
lparameters cS, cLinePre
local i, inExp, cStr, inBrack, c, lOpen, nLen
cStr= ''
nLen= 0
for i = 1 to len(m.cS)
  c= substr(m.cS, i)
  if empty(chrtran(m.c, chr(9), ''))
    exit
  endif
  nLen= m.nLen + 1
  do case
  case m.c = k_EXP_OPEN
    i= i + 2
    inExp = .T.
    if m.lOpen
      cStr= m.cStr + k_QUOTE_CLOSE + " + "
      lOpen= .F.
    endif
  case m.c = k_EXP_CLOSE
    i= m.i + 1
    inExp= .F.
    if !empty(substr(m.cS, m.i + 1))
      cStr= m.cStr + " + " + k_QUOTE_OPEN
      lOpen= .T.
      nLen= 0
    endif
  case m.inExp
    cStr= m.cStr + substr(m.cS, i, 1)
  case left(m.c, 1) $ k_SPECIAL
    if m.lOpen
      cStr= m.cStr + k_QUOTE_CLOSE + " + "
    endif
    cStr= m.cStr + k_QUOTE2_OPEN + m.cLinePre + left(m.c, 1) + k_QUOTE2_CLOSE + " + "
    cLinePre= ''
    if m.lOpen
      cStr= m.cStr + k_QUOTE_OPEN
    endif
  otherwise
    if !m.lOpen
      cStr= m.cStr + k_QUOTE_OPEN + m.cLinePre
      lOpen= .T.
      nLen= m.nLen + len(m.cLinePre)
      cLinePre= ''
    endif
    if m.nLen &gt; k_MAX_STRING
      cStr= m.cStr + k_QUOTE_CLOSE + " + " + k_QUOTE_OPEN
      nLen= 0
    endif
    cStr= m.cStr + substr(m.cS, i, 1)
  endcase
endfor
cStr= strtran(m.cStr, k_EXP_OPEN, k_QUOTE_CLOSE + " + ")
cStr= strtran(m.cStr, k_EXP_CLOSE, " + " + k_QUOTE_OPEN)
if m.lOpen
  cStr= m.cStr + k_QUOTE_CLOSE
endif
return m.cStr

</code></pre></div>
<p>The precise way to call this code will depend on how you intend to use it.
I have provided the basic calling structure, but a better way to do this is to compile a directory of script files into one single prg which you can add to your SET PROCEDURE line.
You can also on-the-fly compile these pages off disk as they are called.</p>
<div class="highlight"><pre><code class="language-XBase" data-lang="XBase">### Example Calling Code

local cIn, cOut, cS
cIn= filetostr("c:\test.htm")
cOut= compilePage(m.cIn, "__test")
strtofile(m.cOut, "c:\test.prg")
open database (home(2) + "northwind\northwind")
use northwind!Customers in 0
do __test in C:\test.prg with cS
?cS
close databases all
</code></pre></div>
<p>You can point the &quot;compiler&quot; at any text based file you like, a very basic example is provided below.
Along with the procedure this would generate.</p>
<div class="highlight"><pre><code class="language-XBase" data-lang="XBase">### Example Input

The time is &lt;%= ttoc(datetime()) %&gt;
&lt;%
  select Customers
  scan
%&gt;
    Customer: &lt;%= Customers.CustomerID %&gt;&lt;br /&gt;
&lt;% endscan %&gt;

</code></pre></div><div class="highlight"><pre><code class="language-XBase" data-lang="XBase">### Example Output

function __test
lparameters __cS
__cS= []
__cS= m.__cS + [The time is ] +  ttoc(datetime()) + chr(13)+chr(10) 
select Customers
scan
__cS= m.__cS + [    Customer: ] +  Customers.CustomerID  + [&lt;br /&gt;] + chr(13)+chr(10) 
endscan
</code></pre></div>
<p>I find this a nice way to separate the &#39;design&#39; of text content from your code.
I am sure we have all at one stage experienced the nightmare of trying to maintain complex string building code inside fox itself.
Not fun.</p>

<p>To try out this code:</p>

<ul>
<li>Copy and paste the code block into a procedure file</li>
<li>SET PROCEDURE TO the above file</li>
<li>Copy and paste the input example into a file called c:\test.htm</li>
<li>Run the example calling code from the command window</li>
</ul>

    </section>
</article>


  <footer class="m-f">
      <section class="copyright">All content copyright <a href="/">Chris Sainty</a> &copy; 2006-2017 &bull; All rights reserved.</section>
  </footer>
</body>
</html>
