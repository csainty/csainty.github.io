<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="shortcut icon" href="/images/favicon.png" />
    <style>
    html,body,li,p{margin:0;padding:0}p,ul,ol,.highlight{margin:1.6em 0}h1,h2,h3,h4{margin:0;padding:0;font-size:100%;font-weight:bold;text-rendering:optimizeLegibility;font-family:sans-serif}ul{list-style:none}html{box-sizing:border-box;font-size:62.5%}*{box-sizing:inherit}*:before,*:after{box-sizing:inherit}img{height:auto;max-width:100%}pre,code{font-family:monospace;margin:0}hr{display:block;height:1px;border:0;border-top:1px solid #efefef;margin:1rem 0;padding:0}blockquote{font-style:italic;margin:1.6em 0 1.6em -2.2em;padding:0 0 0 1.6em;border-left:#4a4a4a 0.4em solid}html{font-size:16px}@media screen and (min-width: 900px){html{font-size:18px}}@media screen and (min-width: 1200px){html{font-size:20px}}body{font-family:serif;color:#3A4145}h1{font-size:2rem;margin:10px 0 10px 0;letter-spacing:-1px}h2{font-size:1.4rem;letter-spacing:-1px}h3{font-size:1.2rem}h4{font-size:1.1rem}a:link,a:visited{color:inherit;text-decoration:none}a:hover{color:#57A3E8;transition:color ease 0.3s}p a:link,p a:visited{text-decoration:underline}pre{border:1px solid #E3EDF3;padding:10px;font-size:0.85em;border-radius:3px}code{padding:1px 3px;font-size:0.85em;white-space:pre;border:1px solid #E3EDF3;background:#F7FAFB;border-radius:2px}pre code{background:transparent;padding:0;border:0}.m-h{text-align:center;background-color:#303538;color:#fff;padding:1rem}.m-h h2{font-weight:normal;font-size:1.5rem}article{width:80%;margin:1rem auto;padding-bottom:1rem;border-bottom:#EBF2F6 1px solid;word-break:break-word;position:relative}article::after{display:block;content:"";width:7px;height:7px;border:#E7EEF2 1px solid;position:absolute;bottom:-5px;left:50%;margin-left:-5px;background:#fff;border-radius:100%;box-shadow:#fff 0 0 0 5px}.a-m{color:#9EABB3;font-size:0.8rem}.a-m a:hover{color:#9EABB3;text-decoration:underline}.a-h{margin-bottom:5px}.r-m{font-size:smaller}nav{position:relative;width:75%;margin:1rem auto;font-size:0.8rem;color:#9EABB3;text-align:center}.m-f{position:relative;margin:2rem 0 0 0;padding:1rem 1rem 2rem 1rem;border-top:#EBF2F6 1px solid;font-size:0.8rem;line-height:1.7em;color:#BBC7CC;text-align:center;background:#F7FAFB}.o-p,.n-p{position:absolute;display:inline-block;padding:0 0.5rem;border:#EBF2F6 2px solid;text-decoration:none;border-radius:30px;transition:border ease 0.3s}.o-p{right:0}.n-p{left:0}.t-h{width:80%;margin:0 auto}.highlight pre{background-color:#49483e;color:white;overflow:scroll}.ge{font-style:italic}.gs{font-weight:bold}.c,.cm,.cp,.c1,.gu,.cs{color:#75715e}.k,.kc,.kd,.kp,.kr,.no,.kt{color:#66d9ef}.l,.mf,.mh,.mi,.mo,.se,.il,.m{color:#ae81ff}.n,.nb,.ni,.nl,.nn,.py,.nv,.w,.bp,.vc,.vg,.vi,.p{color:#f8f8f2}.o,.nt,.ow,.gd,.kn{color:#f92672}.ld,.sb,.sc,.sd,.s2,.sh,.si,.sx,.sr,.s1,.ss,.s{color:#e6db74}.na,.nc,.nd,.ne,.nf,.nx,.gi{color:#a6e22e}

    </style>

    <!-- Begin Jekyll SEO tag v2.0.0 -->
<title>WPF + Strong Typing - Chris Sainty</title>
<meta property="og:title" content="WPF + Strong Typing" />
<meta name="description" content="I have been working with WPF recently, and one of the things that annoys me most is the usage of strings to reference object properties. This mainly affects Bindings, but also pops up in other places such as the IDataErrorInfo interface.  " />
<meta property="og:description" content="I have been working with WPF recently, and one of the things that annoys me most is the usage of strings to reference object properties. This mainly affects Bindings, but also pops up in other places such as the IDataErrorInfo interface.  " />
<link rel="canonical" href="https://blog.csainty.com/2009/11/wpf-strong-typing.html" />
<meta property="og:url" content="https://blog.csainty.com/2009/11/wpf-strong-typing.html" />
<meta property="og:site_name" content="Chris Sainty" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2009-11-05T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@csainty" />
<meta name="twitter:creator" content="@Chris Sainty" />
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "WPF + Strong Typing",
    "datePublished": "2009-11-05T00:00:00+00:00",
    "description": "I have been working with WPF recently, and one of the things that annoys me most is the usage of strings to reference object properties. This mainly affects Bindings, but also pops up in other places such as the IDataErrorInfo interface.  ",
    "url": "https://blog.csainty.com/2009/11/wpf-strong-typing.html"
  }
</script>
<!-- End Jekyll SEO tag -->
</head>
<body>
  <header class="m-h">
    <h1><a href="https://blog.csainty.com">Chris Sainty</a></h1>
    <h2>A technical blog covering full-stack web development.</h2>
    <h2><a href="https://twitter.com/csainty" rel="external">twitter</a> | <a href="https://github.com/csainty" rel="external">github</a> | <a href="https://stackoverflow.com/users/625695/chris-sainty" rel="external">stackoverflow</a></h2>
  </header>

  <article>
    <span><time datetime="05 Nov 2009">05 Nov 2009</time>  </span>
    <h1>WPF + Strong Typing</h1>
    <section>
        <p>I have been working with WPF recently, and one of the things that annoys me most is the usage of strings to reference object properties. This mainly affects Bindings, but also pops up in other places such as the <a href="http://msdn.microsoft.com/en-us/library/system.componentmodel.idataerrorinfo.aspx">IDataErrorInfo</a> interface.  </p>

<!-- more -->

<p>Here is an example that anyone who has touched WPF should understand.  </p>
<div class="highlight"><pre><code class="language-xml" data-lang="xml"> <span class="nt">&lt;TextBox</span> <span class="na">Name=</span><span class="s">"textBox1"</span> <span class="na">Text=</span><span class="s">"{Binding DataItem}"</span> <span class="nt">/&gt;</span>
</code></pre></div>
<p>This particularly bothers me when writing a project from scratch where the data model is still evolving and there is refactoring going on. While some tools like ReSharper are pretty good at picking these up and changing them when you rename a property, you are still relying on the correct usage of a tool rather than the compiler to keep everything in sync.  </p>

<p>Now perhaps I am just bad at bing-ing (not quite as catchy as Google’s verbs is it) but this issue seems to be really difficult to find any good coverage on. There are a number of posts around with people complaining, and there are a number of cranky comments on those blogs from people who just say deal with it, but there is very little in the way of a solution. And from what I have seen there is no attempt to improve the situation in the next release of VS/WPF/C#.  </p>

<p>Now I don’t have a perfect solution to offer either, but I do have a little class that makes my life easier. It is similar code to what you will find inside some LINQ providers if you dig into them and involves breaking a <a href="/2007/12/linq-to-sql-lambda-expressions.html">Lambda Expression</a> down into a useful form (in this case a string).  </p>

<p>First things first, this involves moving your bindings from the XAML and into the code-behind file (or some other place that has access to the controls). Personally I prefer this, I like to put as little into XAML as possible. I see the XAML as a visual layer, therefore beyond visual styling and control names I try to keep my XAML files empty. I personally do both data binding and event binding in the code behind, always have. </p>

<p>If this is unacceptable to you for whatever reason, then I can do nothing to help your assumed string based data binding woes.  </p>

<p>On to the code.   </p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq.Expressions</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">MagicStringBlog</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">MagicString</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="n">Get</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;&gt;</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">string</span> <span class="n">name</span><span class="p">;</span>
            <span class="k">switch</span> <span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="n">Body</span><span class="p">.</span><span class="n">NodeType</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">case</span> <span class="n">ExpressionType</span><span class="p">.</span><span class="n">MemberAccess</span><span class="p">:</span>
                    <span class="n">name</span> <span class="p">=</span> <span class="n">ex</span><span class="p">.</span><span class="n">Body</span><span class="p">.</span><span class="nf">ToString</span><span class="p">();</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="n">ExpressionType</span><span class="p">.</span><span class="n">Convert</span><span class="p">:</span>
                    <span class="n">name</span> <span class="p">=</span> <span class="p">((</span><span class="n">UnaryExpression</span><span class="p">)</span><span class="n">ex</span><span class="p">.</span><span class="n">Body</span><span class="p">).</span><span class="n">Operand</span><span class="p">.</span><span class="nf">ToString</span><span class="p">();</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">default</span><span class="p">:</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">"Expression type {0} unknown"</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="n">Body</span><span class="p">.</span><span class="n">NodeType</span><span class="p">));</span>
             <span class="p">}</span>

             <span class="n">name</span> <span class="p">=</span> <span class="n">name</span><span class="p">.</span><span class="nf">Substring</span><span class="p">(</span><span class="n">name</span><span class="p">.</span><span class="nf">IndexOf</span><span class="p">(</span><span class="sc">'.'</span><span class="p">)</span> <span class="p">+</span> <span class="m">1</span><span class="p">);</span>    <span class="c1">// remove the lambda name from expression (d=&gt;d.Test to Test)
</span>            <span class="k">return</span> <span class="n">name</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>I stole the name <code>MagicString</code> from a blog post I read a while ago about configuring NHibernate and how all the strings were “magic” because you just had to assume you have typed them correctly and that they will work. (On a side note for NHibernate users, if you are using the <a href="http://fluentnhibernate.org/">Fluent</a> interface you are likely to find some code very similar to the above in it somewhere)  </p>

<p>The first thing to note is that the <code>Func&lt;T, object&gt;</code> which describes a delegate that takes a parameter of type T and returns something (of type <code>object</code>, so anything) is wrapped in a <a href="http://msdn.microsoft.com/en-us/library/system.linq.expressions.expression.aspx">System.Linq.Expressions.Expression</a>. I’ve never looked at how this precisely works, but the end result is that instead of getting a reference to a delegate that can be <code>.Invoke()</code>’d you get an expression tree that can be analysed, modified, compiled and then executed. Note that here I only perform step one of that sequence, there is no attempt at execution made. </p>

<p>These expressions are at the core of how a LINQ provider such as LINQ-to-SQL can take your <code>.Where(d=&gt;d.PK==1)</code> and turn it into a SQL statement rather than returning all the objects from the database and running that piece of code over them as CLR objects.  </p>

<p>The contents of the method are not as important as the signature, but basically it analyses the expression, pulls out the name of the property being referenced and returns it. The only complication comes from types that are wrapped to be returned as an object, for example bool, then you need to dig inside the casting operator.  </p>

<p>And here is how we call it in the case of a data binding.  </p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">textBox2</span><span class="p">.</span><span class="nf">SetBinding</span><span class="p">(</span><span class="n">TextBox</span><span class="p">.</span><span class="n">TextProperty</span><span class="p">,</span> <span class="n">MagicString</span><span class="p">.</span><span class="n">Get</span><span class="p">&lt;</span><span class="n">DataClass</span><span class="p">&gt;(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">DataItem</span><span class="p">));</span>
</code></pre></div>
<p>For the record here is the data class that is being used. Complicated!  </p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">namespace</span> <span class="nn">MagicStringBlog</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">DataClass</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">DataItem</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>It’s worth noting that I find the binding expression above too long as well, and have created an <a href="/2008/01/extension-methods.html">Extension Method</a> on controls that has the following signature.  </p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="n">Bind</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">FrameworkElement</span> <span class="n">el</span><span class="p">,</span> <span class="n">DependencyProperty</span> <span class="n">dp</span><span class="p">,</span> <span class="n">Expression</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="kt">object</span><span class="p">&gt;&gt;</span> <span class="n">ex</span><span class="p">)</span>
</code></pre></div>
<p>Which cuts down the call time binding code to  </p>
<div class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">textBox2</span><span class="p">.</span><span class="n">Bind</span><span class="p">&lt;</span><span class="n">DataClass</span><span class="p">&gt;(</span><span class="n">TextBox</span><span class="p">.</span><span class="n">TextProperty</span><span class="p">,</span> <span class="n">d</span><span class="p">=&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">DataItem</span><span class="p">);</span>
</code></pre></div>
<p>With this in place, even the Visual Studio rename tools will find the property and tidy up its name if your objects change, and it will be checked at compile time.  </p>

<p>Now I said earlier that this solution is not perfect, and I meant that. One problem is that all we are doing is turning a string literal into a runtime generated string. There is nothing that is going to check that the DataContext of the <code>TextBox</code> is actually of the type you are binding to, and you are going to suffer some performance hit (I haven’t run the numbers to see how much of one), but the safety this does bring I find useful. I didn’t move to C# only to need to search my code for string literals every time I want to rename a property.  </p>

    </section>
</article>


  <footer class="m-f">
      <section class="copyright">All content copyright <a href="/">Chris Sainty</a> &copy; 2006-2017 &bull; All rights reserved.</section>
  </footer>
</body>
</html>
